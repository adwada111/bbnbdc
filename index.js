const { Client, GatewayIntentBits } = require('discord.js');
const { joinVoiceChannel } = require('@discordjs/voice');
const config = require('./config.json');
const fs = require('fs');

// ملف لتخزين قناة الصوت الحالية
const VOICE_CHANNEL_FILE = './voiceChannel.json';

// تحميل أو تعيين قناة الصوت الافتراضية
let FIXED_VOICE_CHANNEL_ID = "1341677527952785458"; // قناة افتراضية
if (fs.existsSync(VOICE_CHANNEL_FILE)) {
    FIXED_VOICE_CHANNEL_ID = JSON.parse(fs.readFileSync(VOICE_CHANNEL_FILE)).channelId;
}

const clientOptions = {
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent,
        GatewayIntentBits.GuildMembers,
        GatewayIntentBits.GuildVoiceStates
    ]
};

// رسائل محادثة طبيعية موسعة جدًا
const greetings = [
    "السلام عليكم ورحمة الله", "مرحباً يا أحلى ناس", "صباح الخير يا جماعة", "مساء الخير على الطيبين", 
    "هلا وغلا بالجميع", "سلام يا أهل الخير", "صباحكم عسل", "مساكم فل وياسمين", "هلا بالغاليين", 
    "السلام عليكم يا شباب العيد", "مرحباً يا أهل رمضان", "صباح مبارك عليكم", "هلا يا أهل الدار", 
    "سلام يا أصحاب القلوب الطيبة", "صباح الورد والياسمين", "مساء السعادة يا أحباب", "هلا بأهل المحبة", 
    "السلام عليكم يا إخواني", "مرحباً يا ناس الخير", "صباحكم فرح", "مساكم خير وبركة", 
    "هلا باللي ينورون الجلسة", "سلام يا أهل السعادة", "صباح النشاط والحيوية", "مساء الطيب والجمال", 
    "السلام عليكم يا أهل الوفا", "مرحباً يا أهل الزين", "صباحكم أمل", "مساكم نور وسرور", 
    "هلا يا أصحاب الطيبة", "سلام على الجميع", "صباح الخير والبركة", "مساء الهنا يا أغلى الناس", 
    "السلام عليكم يا أهل الفضل", "مرحباً يا أهل العز", "صباحكم حياة", "مساكم سلام", 
    "هلا باللي يملون العين", "سلام يا أهل الجود", "صباح الإخلاص", "مساء الراحة والطمأنينة", 
    "السلام عليكم يا أهل الكرم", "مرحباً يا أهل الشهامة", "صباحكم رضى", "مساكم عافية", 
    "هلا بأهل القلوب النظيفة", "سلام يا أهل الإحسان", "صباح البهجة", "مساء الفرح والأمل"
];

const responses = [
    "وعليكم السلام ورحمة الله", "هلا بيك يا الغالي", "صباح النور والسرور", "مساء النور يا حلو", 
    "أهلين وسهلين", "وعليكم السلام يا أخوان", "صباحك نور", "مساك طيب", "هلا والله بالطيبين", 
    "سلام يا أهل الدار", "وعليكم السلام يا أهل العيد", "هلا برمضان والخير", "صباحك فل", 
    "مساك ياسمين", "أهلين يا أخوي", "وعليكم السلام يا أهل الطيب", "صباحك زين", "مساك حلو", 
    "هلا بيك يا أبو الجود", "سلام يا أهل الكرم", "صباحك سعادة", "مساك فرح", "وعليكم السلام يا أحباب", 
    "هلا يا نور العين", "صباحك عافية", "مساك بركة", "أهلين يا أهل الوفا", "وعليكم السلام يا أهل الزين", 
    "صباحك خير", "مساك جميل", "هلا باللي ينور المكان", "سلام يا أهل العز", "صباحك هنا", 
    "مساك راحة", "وعليكم السلام يا أهل الجمال", "هلا يا أهل الشهامة", "صباحك رضى", "مساك طمأنينة", 
    "أهلين يا أهل القلوب الكبيرة", "وعليكم السلام يا أهل الإخلاص", "صباحك أمل", "مساك سلامة", 
    "هلا بأهل المحبة والطيب", "سلام يا أهل الفضل", "صباحك نور وهنا", "مساك خير وسرور", 
    "وعليكم السلام يا أهل الإحسان", "هلا يا أهل الجود", "صباحك بهجة", "مساك عز وفخر"
];

const questions = [
    "كيف حالك اليوم؟", "شو أخباركم مع العيد؟", "كيف رمضان معاكم؟", "شو صار معكم اليوم؟", 
    "كيف قضيتوا يوم العيد؟", "شو أحلى شي سويتوه برمضان؟", "كيف الأجواء عندكم؟", "شو أخبار السفرة اليوم؟", 
    "كيف الجو مع العيلة؟", "شو جديدكم بالأخبار؟", "كيف كان يومكم أمس؟", "شو خططكم للعيد الجاي؟", 
    "كيف كان الإفطار اليوم؟", "شو سويتوا بالسوق؟", "كيف كانت الزيارة عند الأهل؟", "شو أخبار الشغل اليوم؟", 
    "كيف الجو بالبيت؟", "شو سمعتوا عن الفعاليات؟", "كيف كان السحور أمس؟", "شو أحلى شي باليوم؟", 
    "كيف قضيتوا الإجازة؟", "شو خططكم لرمضان الجاي؟", "كيف كانت الصلاة بالمسجد؟", "شو أخبار الأولاد؟", 
    "كيف الجو بالسفر؟", "شو جديدكم بالبيت؟", "كيف كان يومكم مع الأصحاب؟", "شو سويتوا بالعطلة؟", 
    "كيف الأمور معاكم اليوم؟", "شو أخبار الطبخ اليوم؟", "كيف كانت الألعاب النارية؟", "شو سمعتوا عن المطر؟", 
    "كيف كان يومكم بالمدرسة؟", "شو خططكم للجمعة؟", "كيف كانت الطلعة أمس؟", "شو أحلى شي شفتوه اليوم؟", 
    "كيف الأخبار عند الجيران؟", "شو سويتوا بالحديقة؟", "كيف كان الجو بالمزرعة؟", "شو أخبار السوق اليوم؟", 
    "كيف كانت القهوة الصبح؟", "شو جديدكم بالشارع؟", "كيف كان يومكم بالدوام؟", "شو خططكم للشتاء؟", 
    "كيف الأجواء بالمدينة؟", "شو أخبار الأسعار اليوم؟", "كيف كان اليوم مع العيال؟", "شو سويتوا بالمول؟", 
    "كيف كانت الأخبار بالتلفزيون؟", "شو أحلى ذكرى عندكم؟", "كيف كان الجو بالليل؟"
];

const answers = [
    "الحمد لله بخير ونعمة", "تمام يا خوي، وأنت؟", "كويس والله، اليوم حلو", "الحمد لله كل شي زين", 
    "العيد كان روعة مع العيلة", "رمضان حلو بس تعبنا شوي", "اليوم كان هادي وممتع", "بخير يا الغالي، وأنت؟", 
    "كل شي تمام الحمد لله", "الأخبار حلوة اليوم", "كان يوم ممتع وطبيعي", "العيد كان فرحة كبيرة", 
    "الحمد لله الجو حلو", "كل شي زين وماشي", "اليوم كان مريح جدًا", "بخير والله، شكرًا", 
    "رمضان كان مليان خير", "العيد كان حياة مع الأهل", "اليوم كان عادي بس حلو", "الحمد لله الأمور طيبة", 
    "كنت مرتاح اليوم", "الجو كان عجيب", "بخير وصحة، وأنت؟", "كل شي حلو الحمد لله", 
    "العيد كان مليان ضحك", "رمضان كان هادي وجميل", "اليوم كان يوم نشاط", "بخير يا أخوي، وأنت؟", 
    "الأخبار كانت مفرحة", "كان يوم هادي وطبيعي", "العيد كان أحلى مع الأصحاب", "رمضان كان مليان بركة", 
    "اليوم كان يوم خفيف", "الحمد لله كل شي على ما يرام", "كنت مبسوط اليوم", "الجو كان يهبل", 
    "بخير والحمد لله دائمًا", "كل شي ماشي زين", "العيد كان يوم لا ينسى", "رمضان كان أحلى هالسنة", 
    "اليوم كان مليان حياة", "بخير يا الطيب، وأنت؟", "الأخبار كانت عادية", "كان يوم حلو ومميز", 
    "العيد كان كله فرح", "رمضان كان مليان عبادة", "اليوم كان يوم عادي وطيب", "الحمد لله كل شي بخير", 
    "كنت مستمتع اليوم", "الجو كان يبرد شوي", "بخير وأنت كيفك؟"
];

const eidTalk = [
    "العيد كان عجيب هالسنة", "شفتوا زينة العيد بالشوارع؟", "أحلى شي بالعيد الكبسة", "كم زاركم بالعيد؟", 
    "العيدية هالسنة كانت محترمة", "كنت أوزع حلويات العيد أمس", "شفتوا الألعاب النارية يوم العيد؟", 
    "العيد بدون عيلتنا مو حلو", "كنت بالسوق أشتري للعيد", "أحب أجواء العيد بالليل", 
    "العيد كان مليان ضحك مع الأهل", "كم بيت زرتوا يوم العيد؟", "العيد هالمرة كان غير", 
    "أحلى ذكرى بالعيد لما تجمعنا", "كنت أساعد أمي بالعيدية", "العيد كان مليان ناس وفرح", 
    "شفتوا العرض بالعيد؟", "كنت ألبس جديد يوم العيد", "أحب أسمع أغاني العيد", "كم عيدية جمعتوا؟", 
    "العيد كان كله أكل حلو", "كنت أزور الجدة يوم العيد", "شفتوا الزحمة بالعيد؟", "العيد كان يوم مشمس", 
    "أحب أشوف العيال يلعبون بالعيد", "كنت أسوي قهوة للضيوف بالعيد", "العيد كان مليان هدايا", 
    "كم مرة أكلتوا حلو بالعيد؟", "شفتوا الناس بالمصلى؟", "العيد كان أحلى مع الأصحاب", 
    "كنت أتمشى بالحي يوم العيد", "أحب ريحة البخور بالعيد", "العيد كان يوم هادي وحلو", 
    "كم هدية أخذتوا بالعيد؟", "شفتوا الأضواء بالشوارع؟", "كنت أساعد أبوي بالذبيحة", 
    "العيد كان مليان سوالف", "أحب أشوف الزينة بالبيت", "كنت ألعب مع العيال بالعيد", 
    "شفتوا الألعاب بالمهرجان؟", "العيد كان كله فرح ووناسة", "كم زيارة سويتوا؟", 
    "أحب أسمع تهاني العيد", "كنت أشتري ملابس جديدة", "العيد كان يوم مشمس وجميل", 
    "شفتوا الناس بالسوق؟", "كنت أوزع فلوس على العيال", "أحب أجواء العيد بالصبح", 
    "العيد كان مليان أكل وشرب", "كم مرة سلمتم على الناس؟", "شفتوا العروض بالتلفزيون؟"
];

const ramadanTalk = [
    "رمضان هالسنة مر بسرعة", "أحب السحور مع العيلة", "كنت أصلي التراويح أمس", "شو طبختوا للإفطار اليوم؟", 
    "رمضان بدون قهوة مو رمضان", "كنت أقرأ قرآن اليوم", "أجواء رمضان بالمسجد حلوة", "شفتوا مسلسل رمضان الجديد؟", 
    "الإفطار أمس كان عجيب", "كم يوم صمتوا برمضان؟", "رمضان هالسنة كان هادي", "أحب الزينة برمضان", 
    "كنت أوزع تمر بالمسجد", "السحور اليوم كان خفيف", "رمضان يجمعنا كل يوم", "كنت أساعد أمي بالطبخ", 
    "شفتوا الإفطار الجماعي؟", "أحب أسمع الأذان برمضان", "كم مرة قرأتوا القرآن؟", "رمضان كان مليان عبادة", 
    "كنت أروح المسجد كل ليلة", "شو أحلى أكلة سويتوها؟", "أحب أشوف الزينة بالشوارع", "الإفطار كان مليان ناس", 
    "كنت أصوم وأنا مبسوط", "رمضان كان هادي وجميل", "شفتوا القمر ليلة رمضان؟", "أحب أسمع الدعاء بالمسجد", 
    "كم مرة أفطرتوا عند الجيران؟", "كنت أسوي عصير للإفطار", "رمضان كان مليان خير", "شو أخبار التراويح عندكم؟", 
    "أحب ريحة القهوة برمضان", "كنت أوزع ماء على الناس", "رمضان كان أحلى مع الأهل", "شفتوا الزحمة بالسوق؟", 
    "كم يوم تعبتوا من الصيام؟", "كنت أسمع القرآن بالسيارة", "أحب أجواء السحور بالليل", "رمضان كان مليان بركة", 
    "شو سويتوا ليلة القدر؟", "كنت أصلي بالبيت أحيانًا", "أحب أشوف الناس بالمساجد", "الإفطار كان كله أكل حلو", 
    "كم مرة زرتوا الأهل برمضان؟", "كنت أسوي حلويات للإفطار", "رمضان كان يوميًا حلو", "شفتوا الفعاليات برمضان؟", 
    "أحب أسمع الأناشيد برمضان", "كنت أروح السوق لرمضان", "رمضان كان مليان سوالف حلوة"
];

const newsTalk = [
    "شفتوا الأخبار اليوم؟", "يقولون الجو بيبرد الأسبوع الجاي", "سمعتوا عن المباراة أمس؟", 
    "الأخبار تقول السوق بيرخص", "شفتوا الفيديو اللي نزل اليوم؟", "يقولون فيه فعالية بالمدينة", 
    "الأخبار اليوم كلها عن العيد", "سمعتوا عن الإجازة الجديدة؟", "الجو بالأخبار حلو اليوم", 
    "شفتوا آخر خبر عن السفر؟", "يقولون فيه مطر بكرة", "الأخبار مليانة أحداث اليوم", 
    "سمعتوا عن العرض الجديد؟", "الأخبار تقول اليوم بيكون مشمس", "شفتوا الخبر عن المهرجان؟", 
    "يقولون فيه خصومات بالسوق", "سمعتوا عن الفعالية بالحي؟", "الأخبار كانت عن الجو أمس", 
    "شفتوا الخبر عن المدرسة؟", "يقولون فيه زحمة بالطريق", "الأخبار تقول بيكون برد قوي", 
    "سمعتوا عن السفرة الجديدة؟", "شفتوا الفيديو اللي صار ترند؟", "يقولون فيه إجازة طويلة", 
    "الأخبار كانت حلوة اليوم", "شفتوا الخبر عن الأسعار؟", "يقولون فيه فعاليات للعيد", 
    "سمعتوا عن المطر بالشمال؟", "الأخبار تقول الجو بيتغير", "شفتوا آخر خبر بالجوال؟", 
    "يقولون فيه عروض بالمول", "سمعتوا عن الإعلان الجديد؟", "الأخبار كانت عن رمضان", 
    "شفتوا الخبر عن الشغل؟", "يقولون فيه مطر خفيف بكرة", "الأخبار مليانة سوالف حلوة", 
    "سمعتوا عن العطلة الرسمية؟", "شفتوا الفيديو عن العيد؟", "يقولون فيه فعالية بالساحة", 
    "الأخبار تقول بيكون جو حلو", "سمعتوا عن السوق الجديد؟", "شفتوا الخبر عن السيارات؟", 
    "يقولون فيه خصم كبير", "الأخبار كانت عن المباراة", "سمعتوا عن الجو بالجنوب؟", 
    "شفتوا آخر خبر عن الطيران؟", "يقولون فيه مهرجان كبير", "الأخبار تقول بيكون يوم مشمس", 
    "سمعتوا عن العروض بالمحلات؟", "شفتوا الخبر عن الإجازة؟"
];

const dailyTalk = [
    "اليوم كان حلو وهادي", "كنت أتمشى اليوم بالحديقة", "الجو اليوم يجنن", "شو سويتوا اليوم؟", 
    "كنت أشتري قهوة الصبح", "اليوم كان مليان شغل", "كنت عند الجدة أمس", "شو أكلتوا اليوم؟", 
    "اليوم هواية مريح", "كنت ألعب مع العيال اليوم", "الجو اليوم يبيله طلعة", "كنت أقرأ كتاب اليوم", 
    "شو خططكم لهاليوم؟", "اليوم كان عادي بس حلو", "كنت أسولف مع الشباب أمس", "كنت أشتري حاجات البيت", 
    "اليوم كان يوم نشاط", "شو سويتوا بالمدرسة؟", "كنت أروح السوق اليوم", "الجو كان بارد شوي", 
    "كنت أساعد أبوي بالبيت", "شو أخبار الدوام اليوم؟", "اليوم كان مليان ضحك", "كنت أشوف مباراة أمس", 
    "كنت أتمشى بالشارع", "شو سويتوا بالجمعة؟", "اليوم كان يوم هادي وطيب", "كنت أشتري أكل الغدا", 
    "كنت ألعب بالحديقة", "شو أخبار الأصحاب اليوم؟", "الجو كان حلو بالليل", "كنت أسوي قهوة العصر", 
    "اليوم كان مليان شغل البيت", "كنت أروح عند الجيران", "شو سويتوا بالمزرعة؟", "كنت أشوف فلم اليوم", 
    "كنت أتمشى مع العيلة", "شو أكلتوا بالعشا؟", "اليوم كان يوم عادي وممتع", "كنت أسمع أغاني الصبح", 
    "كنت أشتري حلويات اليوم", "شو خططكم للغدا؟", "الجو كان يبيله قهوة", "كنت أسولف مع أمي أمس", 
    "كنت أروح المول اليوم", "شو سويتوا بالصبح؟", "اليوم كان مليان سوالف", "كنت أشوف الغروب أمس", 
    "كنت ألعب مع الكلب اليوم", "شو أخبار الحي عندكم؟", "اليوم كان يوم خفيف وحلو"
];

// متابعة آخر رسالة وكاتبها
let lastMessage = null;
let lastAuthor = null;

config.bots.forEach((botConfig, index) => {
    const client = new Client(clientOptions);
    const botNumber = index + 1;
    const botName = botConfig.name || `Bot${botNumber}`;

    client.once('ready', () => {
        console.log(`جاهز! - البوت ${botName} (#${botNumber}) - ${client.user.tag}`);

        // الاتصال بقناة الصوت المحددة مع تأخير 60 ثانية
        const voiceChannel = client.channels.cache.get(FIXED_VOICE_CHANNEL_ID);
        if (voiceChannel && voiceChannel.type === 2) {
            setTimeout(() => {
                try {
                    const connection = joinVoiceChannel({
                        channelId: FIXED_VOICE_CHANNEL_ID,
                        guildId: config.serverId,
                        adapterCreator: voiceChannel.guild.voiceAdapterCreator,
                        selfDeaf: false,
                        selfMute: false
                    });
                    console.log(`البوت ${botName} (#${botNumber}) متصل بقناة الصوت ${FIXED_VOICE_CHANNEL_ID}`);
                    connection.on('error', (error) => {
                        console.error(`خطأ في اتصال الصوت للبوت ${botName} (#${botNumber}):`, error);
                    });
                } catch (error) {
                    console.error(`فشل في الاتصال بقناة الصوت للبوت ${botName} (#${botNumber}):`, error);
                }
            }, index * 60000); // تأخير 60 ثانية بين كل بوت
        } else {
            console.log(`البوت ${botName} (#${botNumber}) لم يجد قناة الصوت ${FIXED_VOICE_CHANNEL_ID}`);
        }

        // محادثة طبيعية بين البوتات بسرعة متوسطة
        const textChannel = client.channels.cache.get(config.textChannelId);
        if (textChannel) {
            setInterval(() => {
                if (Math.random() < 0.35) { // 35% فرصة للكتابة
                    let messageToSend;
                    if (lastMessage && Math.random() < 0.6 && lastAuthor) { // 60% فرصة للرد
                        if (greetings.includes(lastMessage)) {
                            messageToSend = responses[Math.floor(Math.random() * responses.length)];
                        } else if (questions.includes(lastMessage)) {
                            messageToSend = answers[Math.floor(Math.random() * answers.length)];
                        } else if (eidTalk.includes(lastMessage)) {
                            messageToSend = eidTalk[Math.floor(Math.random() * eidTalk.length)];
                        } else if (ramadanTalk.includes(lastMessage)) {
                            messageToSend = ramadanTalk[Math.floor(Math.random() * ramadanTalk.length)];
                        } else if (newsTalk.includes(lastMessage)) {
                            messageToSend = newsTalk[Math.floor(Math.random() * newsTalk.length)];
                        } else {
                            messageToSend = dailyTalk[Math.floor(Math.random() * dailyTalk.length)];
                        }
                        if (Math.random() < 0.4) {
                            messageToSend = `<@${lastAuthor.id}> ${messageToSend}`;
                        }
                    } else { // رسالة جديدة
                        const randType = Math.random();
                        if (randType < 0.2) {
                            messageToSend = greetings[Math.floor(Math.random() * greetings.length)];
                        } else if (randType < 0.4) {
                            messageToSend = questions[Math.floor(Math.random() * questions.length)];
                        } else if (randType < 0.6) {
                            messageToSend = eidTalk[Math.floor(Math.random() * eidTalk.length)];
                        } else if (randType < 0.8) {
                            messageToSend = ramadanTalk[Math.floor(Math.random() * ramadanTalk.length)];
                        } else if (randType < 0.9) {
                            messageToSend = newsTalk[Math.floor(Math.random() * newsTalk.length)];
                        } else {
                            messageToSend = dailyTalk[Math.floor(Math.random() * dailyTalk.length)];
                        }
                        if (Math.random() < 0.3) {
                            const randomBot = config.bots[Math.floor(Math.random() * config.bots.length)];
                            if (randomBot.name !== botName) {
                                const member = textChannel.guild.members.cache.find(m => m.user.tag.startsWith(randomBot.name));
                                if (member) {
                                    messageToSend = `<@${member.id}> ${messageToSend}`;
                                }
                            }
                        }
                    }
                    textChannel.send(messageToSend);
                }
            }, 7000 + index * 1000); // تأخير 7 ثوانٍ + فارق بسيط
        }
    });

    client.on('messageCreate', async (message) => {
        if (message.author.bot) {
            lastMessage = message.content;
            lastAuthor = message.author;
            return;
        }

        const textChannel = client.channels.cache.get(config.textChannelId);
        if (!textChannel) return;

        // إذا كتب عضو حقيقي في قناة النص
        if (message.guild.id === config.serverId && message.channel.id === config.inputChannelId) {
            if (Math.random() < 0.5) { // 50% فرصة للرد
                let reply;
                if (message.content.includes("كيف") || message.content.includes("شو")) {
                    reply = answers[Math.floor(Math.random() * answers.length)];
                } else if (message.content.includes("عيد")) {
                    reply = eidTalk[Math.floor(Math.random() * eidTalk.length)];
                } else if (message.content.includes("رمضان")) {
                    reply = ramadanTalk[Math.floor(Math.random() * ramadanTalk.length)];
                } else {
                    reply = dailyTalk[Math.floor(Math.random() * dailyTalk.length)];
                }
                if (Math.random() < 0.4) {
                    textChannel.send(`<@${message.author.id}> ${reply}`);
                } else {
                    textChannel.send(reply);
                }
            }
        }

        // إذا تكلم المستخدم في الروم الصوتي
        const voiceChannel = client.channels.cache.get(FIXED_VOICE_CHANNEL_ID);
        if (voiceChannel && voiceChannel.members.has(message.author.id)) {
            textChannel.send(message.content); // يكتبون كلامك بدون رد
        }
    });

    client.login(botConfig.token).catch(err => {
        console.error(`فشل تسجيل الدخول للبوت ${botName} (#${botNumber}):`, err);
    });
});

// دالة لتغيير القناة الصوتية يدويًا
function updateVoiceChannel(newChannelId) {
    FIXED_VOICE_CHANNEL_ID = newChannelId;
    fs.writeFileSync(VOICE_CHANNEL_FILE, JSON.stringify({ channelId: newChannelId }));
    console.log(`تم تحديث قناة الصوت إلى: ${newChannelId}`);
}

console.log('جاري التشغيل...');

// لتغيير القناة يدويًا، شغل هذا في الكونسول بعد تشغيل الكود:
// updateVoiceChannel("NEW_CHANNEL_ID");